<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Payment — Aotearoa Adventure Gear</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/custom.css">
</head>
<body>

<header class="site-header">
  <nav class="navbar navbar-expand-lg navbar-light container-limited">
    <a class="navbar-brand" href="index.html">
      <img src="assets/images/BIT703-A2-01-AotearoaAdventureGearLogo-Graphic-2025-04.png" alt="logo" style="height:44px;">
    </a>
  </nav>
</header>

<main>
  <div class="container container-limited py-4">
    <h2>Payment options</h2>

    <!-- ORDER SUMMARY DISPLAY -->
    <div class="alert alert-light border mb-4">
      <strong>Order Summary</strong><br>
      Subtotal: <span id="sumSubtotal">$0.00</span><br>
      Shipping: <span id="sumShipping">$0.00</span><br>
      <strong>Total: <span id="sumTotal">$0.00</span></strong>
    </div>

    <div class="row g-3">

      <!-- Discounts -->
      <div class="col-md-6">
        <div class="card p-3">
          <h5>Discount codes</h5>
          <p class="small text-muted">Apply a discount (demo only).</p>
          <div class="input-group">
            <input id="discountCode" class="form-control" placeholder="Enter code">
            <button id="applyDiscount" class="btn btn-outline-secondary" type="button">Apply</button>
          </div>
          <div id="discountMsg" class="form-text text-success mt-1" style="display:none;">Discount applied.</div>
        </div>
      </div>

      <!-- Gift cards -->
      <div class="col-md-6">
        <div class="card p-3">
          <h5>Gift cards</h5>
          <p class="small text-muted">Redeem a gift card (demo).</p>
          <div class="input-group">
            <input id="giftCard" type="text" class="form-control" placeholder="Gift card code">
            <button id="redeemGift" class="btn btn-outline-secondary" type="button">Redeem</button>
          </div>
          <div id="giftMsg" class="form-text text-success mt-1" style="display:none;">Gift card redeemed.</div>
        </div>
      </div>

      <!-- Payment form -->
      <div class="col-12">
        <div class="card p-3">
          <h5>Card payment</h5>

          <form id="paymentForm" class="row g-3 needs-validation" novalidate>

            <div class="col-md-12">
              <label class="form-label">Card number</label>
              <input id="cardNumber" type="text" class="form-control" pattern="^\d{13,19}$" required>
              <div class="invalid-feedback">Enter a valid 13–19 digit card number.</div>
            </div>

            <div class="col-md-4">
              <label class="form-label">Expiry (MM/YY)</label>
              <input id="exp" class="form-control" pattern="^(0[1-9]|1[0-2])\/\d{2}$" required>
              <div class="invalid-feedback">Use MM/YY format.</div>
            </div>

            <div class="col-md-4">
              <label class="form-label">CVV</label>
              <input id="cvv" class="form-control" pattern="^\d{3,4}$" required>
              <div class="invalid-feedback">3–4 digits required.</div>
            </div>

            <div class="col-md-4">
              <label class="form-label">Cardholder name</label>
              <input id="holder" class="form-control" required>
              <div class="invalid-feedback">Enter cardholder name.</div>
            </div>

            <div class="col-12 text-end">
              <button id="payNow" type="submit" class="btn btn-primary">Pay now (Demo)</button>
              <a href="shipping.html" class="btn btn-outline-secondary">Back</a>
            </div>

          </form>

        </div>
      </div>

    </div>
  </div>
</main>

<footer class="site-footer">
  <div class="container container-limited">
    <div class="row">
      <div class="col">© 2025 Aotearoa Adventure Gear</div>
    </div>
  </div>
</footer>

<!-- Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- PAYMENT LOGIC -->
<script>
document.addEventListener('DOMContentLoaded', () => {

  // ELEMENTS
  const subtotalEl = document.getElementById('sumSubtotal');
  const shippingEl = document.getElementById('sumShipping');
  const totalEl = document.getElementById('sumTotal');

  // LOAD SUBTOTAL + SHIPPING FROM STORAGE
  let subtotal = parseFloat(localStorage.getItem('aag_subtotal') || '0');
  let shippingCost = parseFloat(localStorage.getItem('aag_shipping') || '0');
  let total = subtotal + shippingCost;

  // DISPLAY TOTALS
  function updateDisplay() {
    subtotalEl.textContent = `$${subtotal.toFixed(2)}`;
    shippingEl.textContent = shippingCost === 0 ? 'FREE' : `$${shippingCost.toFixed(2)}`;
    totalEl.textContent = `$${total.toFixed(2)}`;
  }
  updateDisplay();

  // ------------------------------
  // DISCOUNT (Demo: $20 off)
  // ------------------------------
  document.getElementById('applyDiscount').addEventListener('click', () => {
    subtotal = Math.max(0, subtotal - 20);
    total = subtotal + shippingCost;
    updateDisplay();
    const msg = document.getElementById('discountMsg');
    msg.style.display = 'block';
    msg.textContent = 'Discount applied — $20 off (demo).';
  });

  // ------------------------------
  // GIFT CARD (Demo: subtract $50)
  // ------------------------------
  document.getElementById('redeemGift').addEventListener('click', () => {
    subtotal = Math.max(0, subtotal - 50);
    total = subtotal + shippingCost;
    updateDisplay();
    const msg = document.getElementById('giftMsg');
    msg.style.display = 'block';
    msg.textContent = 'Gift card redeemed — $50 off (demo).';
  });

  // ------------------------------
  // PAYMENT FORM VALIDATION
  // ------------------------------
  const form = document.getElementById('paymentForm');

  function expiryValid(exp) {
    if (!/^(0[1-9]|1[0-2])\/\d{2}$/.test(exp)) return false;
    const [mm, yy] = exp.split('/').map(v => parseInt(v));
    const fullYear = 2000 + yy;
    const expiryDate = new Date(fullYear, mm);
    return expiryDate > new Date();
  }

  form.addEventListener('submit', e => {
    if (!form.checkValidity()) {
      e.preventDefault();
      e.stopPropagation();
      form.classList.add('was-validated');
      return;
    }

    const errors = [];
    const n = document.getElementById('cardNumber').value.trim();
    const exp = document.getElementById('exp').value.trim();
    const cvv = document.getElementById('cvv').value.trim();
    const holder = document.getElementById('holder').value.trim();

    if (!/^\d{13,19}$/.test(n)) errors.push('Invalid card number.');
    if (!expiryValid(exp)) errors.push('Invalid expiry date.');
    if (!/^\d{3,4}$/.test(cvv)) errors.push('Invalid CVV.');
    if (!holder) errors.push('Enter cardholder name.');

    if (errors.length) {
      e.preventDefault();
      alert('Payment errors:\n' + errors.join('\n'));
      return;
    }

    // SAVE ORDER FOR CONFIRMATION PAGE
    localStorage.setItem('aag_total', total.toFixed(2));
    localStorage.setItem('aag_payment_method', 'Card');
    localStorage.setItem('aag_cardholder', holder);

    e.preventDefault();
    window.location.href = 'confirmation.html';
  });

});
</script>

</body>
</html>
